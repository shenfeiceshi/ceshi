# 账号密码登录系统配置指南

## 概述

已成功将小六日记从微信一键登录改为传统的账号密码登录系统，保持了云开发架构的优势，同时使用自定义用户管理系统。

## 主要修改内容

### 1. App.js 修改

- **移除微信授权登录**：删除了 `wx.getUserProfile` 相关代码
- **新增账号密码登录**：`userLogin(username, password, callback)` 方法
- **新增用户注册**：`userRegister(username, password, nickname, callback)` 方法
- **Token管理**：支持登录token的存储和验证
- **登录状态检查**：改为基于本地token验证

### 2. 云函数修改

#### 新增云函数
- **register**：用户注册云函数，支持账号密码注册
- **verifyToken**：Token验证云函数，用于验证登录状态

#### 重构云函数
- **login**：从微信openid验证改为账号密码验证
- **getTasks**：使用自定义用户ID替代微信openid
- **addTask**：使用自定义用户ID替代微信openid
- **saveDiary**：使用自定义用户ID替代微信openid
- **getDiaries**：使用自定义用户ID替代微信openid
- **completeTask**：使用自定义用户ID替代微信openid

### 3. 用户数据结构

```javascript
{
  _id: "数据库自动生成ID",
  userId: "user_时间戳_随机字符串", // 自定义用户ID
  username: "用户名",
  password: "SHA256加密后的密码",
  nickname: "昵称",
  avatarUrl: "头像URL",
  points: 0,
  totalDiaries: 0,
  continuousDays: 0,
  lastDiaryDate: null,
  createTime: "注册时间",
  lastLoginTime: "最后登录时间"
}
```

### 4. Token机制

- **Token格式**：`userId_timestamp` 格式
- **有效期**：24小时
- **验证机制**：每次调用云函数时验证token有效性
- **存储位置**：微信小程序本地存储

## 云函数依赖安装指南

### 依赖包安装

所有云函数都需要安装 `wx-server-sdk` 依赖包。已为以下云函数安装了依赖：

- ✅ login
- ✅ register  
- ✅ verifyToken
- ✅ getTasks
- ✅ addTask
- ✅ saveDiary
- ✅ getDiaries
- ✅ completeTask
- ✅ addPoints
- ✅ deductPoints
- ✅ generateAIComment
- ✅ getLotteryPrizes
- ✅ getLotteryRecords
- ✅ lottery
- ✅ updateProfile

**总计：15个云函数，全部已安装依赖**

### 手动安装依赖步骤

如果需要重新安装或添加新的云函数，请按以下步骤操作：

1. **进入云函数目录**
   ```bash
   cd cloudfunctions/[云函数名称]
   ```

2. **安装依赖**
   ```bash
   npm install
   ```

3. **验证安装**
   检查是否生成了 `node_modules` 文件夹和 `package-lock.json` 文件

### 批量安装脚本

可以使用以下命令批量安装所有云函数的依赖：

```bash
# 进入项目根目录
cd /path/to/your/project

# 批量安装
for dir in cloudfunctions/*/; do
  if [ -f "$dir/package.json" ]; then
    echo "Installing dependencies for $(basename "$dir")"
    cd "$dir" && npm install && cd - > /dev/null
  fi
done
```

## 故障排除

### 1. 依赖安装失败

**问题**：npm install 失败或报错

**解决方案**：
- 检查网络连接
- 清理npm缓存：`npm cache clean --force`
- 删除 `node_modules` 和 `package-lock.json`，重新安装
- 使用淘宝镜像：`npm install --registry https://registry.npmmirror.com`

### 2. 云函数部署失败

**问题**：上传云函数时提示依赖缺失

**解决方案**：
- 确保每个云函数目录下都有 `node_modules` 文件夹
- 重新安装依赖：`npm install`
- 检查 `package.json` 文件格式是否正确
- 在微信开发者工具中右键云函数，选择"上传并部署：云端安装依赖"

### 3. wx-server-sdk 版本问题

**问题**：云函数运行时报 wx-server-sdk 相关错误

**解决方案**：
- 检查版本兼容性，当前使用版本：`~2.6.3`
- 如需更新版本，修改 `package.json` 中的版本号
- 重新安装：`npm install wx-server-sdk@latest`

### 4. 权限问题

**问题**：npm install 时提示权限不足

**解决方案**：
- macOS/Linux：使用 `sudo npm install`（不推荐）
- 更好的方案：配置npm全局目录权限
- 使用nvm管理Node.js版本

### 5. 网络问题

**问题**：下载依赖包超时或失败

**解决方案**：
```bash
# 使用淘宝镜像
npm config set registry https://registry.npmmirror.com

# 或者临时使用
npm install --registry https://registry.npmmirror.com
```

- **生成**：登录成功后生成Base64编码的token
- **验证**：每次云函数调用时验证token有效性
- **过期**：Token有效期24小时
- **存储**：本地存储在 `loginToken` 中

## 部署步骤

### 1. 云函数部署

需要部署以下云函数：

1. **login** - 用户登录
2. **register** - 用户注册  
3. **verifyToken** - Token验证
4. **getTasks** - 获取任务列表
5. **addTask** - 添加任务
6. **saveDiary** - 保存日记
7. **getDiaries** - 获取日记列表
8. **completeTask** - 完成任务

### 2. 数据库集合

确保以下集合存在：
- **users** - 用户信息
- **tasks** - 任务数据
- **diaries** - 日记数据
- **pointRecords** - 积分记录

### 3. 部署命令

在微信开发者工具中：
1. 右键点击 `cloudfunctions` 文件夹
2. 选择 "同步云函数列表"
3. 逐个右键点击每个云函数文件夹
4. 选择 "创建并部署：云端安装依赖"

## 使用方法

### 1. 用户注册

```javascript
const app = getApp()
app.userRegister('username', 'password', 'nickname', (err, data) => {
  if (!err) {
    console.log('注册成功', data)
  } else {
    console.error('注册失败', err)
  }
})
```

### 2. 用户登录

```javascript
const app = getApp()
app.userLogin('username', 'password', (err, data) => {
  if (!err) {
    console.log('登录成功', data)
  } else {
    console.error('登录失败', err)
  }
})
```

### 3. 调用云函数

所有云函数调用都需要传递token参数：

```javascript
const app = getApp()
const token = wx.getStorageSync('loginToken')

wx.cloud.callFunction({
  name: 'getTasks',
  data: {
    taskDate: '2024-01-01',
    token: token
  },
  success: (res) => {
    console.log('获取任务成功', res.result.data)
  }
})
```

## 安全特性

1. **密码加密**：使用SHA256加密存储密码
2. **Token验证**：每次请求验证token有效性
3. **用户隔离**：基于userId确保数据隔离
4. **权限验证**：操作前验证用户权限
5. **Token过期**：24小时自动过期机制

## 注意事项

1. **数据迁移**：现有微信用户数据需要手动迁移
2. **兼容性**：确保所有页面都使用新的登录方式
3. **错误处理**：完善token过期和网络错误的处理
4. **用户体验**：添加适当的加载和错误提示

## 测试建议

1. 测试用户注册流程
2. 测试用户登录流程
3. 测试token过期处理
4. 测试数据隔离功能
5. 测试所有云函数调用

## 故障排除

如遇到问题，请检查：
1. 云函数是否正确部署
2. Token是否正确传递
3. 用户权限是否正确验证
4. 数据库集合是否存在
5. 网络连接是否正常