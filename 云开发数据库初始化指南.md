# 云开发数据库初始化配置指南

## 🚨 问题诊断
您遇到的"注册失败"问题确实是因为**云开发数据库集合未创建**导致的。虽然云函数已经配置完成，但数据库集合缺失，导致注册时无法写入用户数据。

## 📋 环境信息
- **云开发环境ID**: `cloud1-7gqey5at68494012`
- **项目类型**: 微信小程序
- **数据库类型**: 云开发文档数据库

## 🎯 第一步：在微信开发者工具中创建数据库集合

### 1.1 打开云开发控制台
1. 在微信开发者工具中，点击顶部菜单栏的 **"云开发"**
2. 选择 **"云开发控制台"**
3. 确认环境ID为 `cloud1-7gqey5at68494012`

### 1.2 创建必需的数据库集合
**⚠️ 重要：必须创建以下6个集合，否则应用功能将无法正常工作**

#### 🔑 集合1: users（用户信息）- **最重要**
```json
{
  "_id": "用户唯一标识",
  "username": "用户名",
  "nickname": "昵称", 
  "password": "加密后的密码",
  "avatar": "头像URL",
  "points": 0,
  "level": 1,
  "createTime": "创建时间",
  "lastLoginTime": "最后登录时间"
}
```

#### 📝 集合2: tasks（任务数据）
```json
{
  "_id": "任务唯一标识",
  "userId": "用户ID",
  "title": "任务标题",
  "description": "任务描述",
  "status": "任务状态(pending/completed/expired)",
  "points": "奖励积分",
  "createTime": "创建时间",
  "completeTime": "完成时间",
  "deadline": "截止时间"
}
```

#### 📖 集合3: diaries（日记数据）
```json
{
  "_id": "日记唯一标识",
  "userId": "用户ID",
  "title": "日记标题",
  "content": "日记内容",
  "mood": "心情状态",
  "weather": "天气",
  "images": "图片数组",
  "createTime": "创建时间",
  "updateTime": "更新时间"
}
```

#### 🎁 集合4: lottery_prizes（抽奖奖品）
```json
{
  "_id": "奖品唯一标识",
  "name": "奖品名称",
  "description": "奖品描述",
  "image": "奖品图片",
  "probability": "中奖概率",
  "points": "所需积分",
  "stock": "库存数量",
  "status": "状态(active/inactive)"
}
```

#### 🎲 集合5: lottery_records（抽奖记录）
```json
{
  "_id": "记录唯一标识",
  "userId": "用户ID",
  "prizeId": "奖品ID",
  "prizeName": "奖品名称",
  "pointsCost": "消耗积分",
  "createTime": "抽奖时间",
  "status": "状态(won/lost)"
}
```

#### 💰 集合6: points_records（积分记录）
```json
{
  "_id": "记录唯一标识",
  "userId": "用户ID",
  "type": "积分类型(earn/spend)",
  "points": "积分数量",
  "reason": "获得/消耗原因",
  "relatedId": "关联ID(任务ID/抽奖ID等)",
  "createTime": "创建时间"
}
```

### 1.3 创建集合的具体操作步骤
1. 在云开发控制台中，点击左侧 **"数据库"**
2. 点击 **"集合"** 标签页
3. 点击 **"添加集合"** 按钮
4. 输入集合名称（如：users）
5. 点击 **"确定"** 创建
6. 重复以上步骤创建所有6个集合

## 🔐 第二步：配置数据库权限（解决注册失败的关键步骤）

### 2.1 快速解决方案（推荐用于测试）
**为了快速解决注册问题，建议先设置开放权限：**

对每个集合设置以下权限：
```json
{
  "read": true,
  "write": true
}
```

### 2.2 设置权限的操作步骤
1. 在数据库控制台中，点击集合名称（如：users）
2. 点击 **"权限设置"** 标签页
3. 将权限设置为上述JSON格式
4. 点击 **"保存"**
5. 对所有6个集合重复此操作

### 2.3 生产环境权限配置（后续优化）
测试通过后，可以设置更严格的权限：

#### users集合权限
```json
{
  "read": "auth.uid != null",
  "write": "auth.uid != null"
}
```

#### 其他集合权限
```json
{
  "read": "auth.uid != null && auth.uid == resource.data.userId",
  "write": "auth.uid != null && auth.uid == resource.data.userId"
}
```

## 🚀 第三步：立即测试注册功能

### 3.1 重新编译项目
1. 在微信开发者工具中，点击 **"编译"** 按钮
2. 确保编译成功

### 3.2 测试注册
1. 在模拟器中打开注册页面
2. 填写测试用户信息：
   - 用户名: testuser001
   - 昵称: 测试用户
   - 密码: 123456
   - 确认密码: 123456
3. 点击注册按钮
4. 观察是否注册成功

### 3.3 验证数据库写入
1. 回到云开发控制台
2. 点击 **"数据库"** → **"users"** 集合
3. 查看是否有新用户记录被创建

## 🔍 第四步：问题排查

### 4.1 如果注册仍然失败
检查以下项目：
- [ ] users集合是否已创建
- [ ] users集合权限是否设置为 `{"read": true, "write": true}`
- [ ] 云开发环境ID是否正确
- [ ] 网络连接是否正常

### 4.2 查看详细错误信息
1. 在云开发控制台中，点击 **"云函数"**
2. 选择 `register` 函数
3. 点击 **"日志"** 查看详细错误信息
4. 查找最近的调用记录和错误详情

### 4.3 测试数据库连接
在微信开发者工具的 **"调试器"** → **"Console"** 中执行：
```javascript
wx.cloud.database().collection('users').get().then(res => {
  console.log('数据库连接成功:', res)
}).catch(err => {
  console.error('数据库连接失败:', err)
})
```

## ✅ 完成检查清单

**立即需要完成的核心步骤：**
- [ ] 创建 users 集合
- [ ] 设置 users 集合权限为开放模式
- [ ] 测试注册功能
- [ ] 验证用户数据写入成功

**可选的优化步骤：**
- [ ] 创建其他5个集合（tasks, diaries, lottery_prizes, lottery_records, points_records）
- [ ] 添加测试数据
- [ ] 创建数据库索引
- [ ] 优化权限配置

## 🎯 预期结果

完成上述步骤后，您应该能够：
1. ✅ 成功注册新用户
2. ✅ 在数据库中看到用户记录
3. ✅ 正常使用登录功能
4. ✅ 解决"注册失败"的问题

## 📞 需要帮助？

如果按照上述步骤操作后仍有问题，请提供：
1. 具体的错误信息
2. 云函数日志截图
3. 数据库集合创建状态截图

---

**🔥 关键提醒：创建 `users` 集合并设置开放权限是解决注册失败问题的核心步骤！**